{% extends "base.html" %}

{% block title %}Sustainability Score - EcoVision{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">Your Sustainability Score</h1>
    
    <div class="box">
        <h2 class="subtitle"><b>Score:</b> {{ latest_result.score }}</h2>
        
        {% if latest_result.breakdown %}
        <h3 class="subtitle">Breakdown</h3>
        <ul>
            {% for item in latest_result.breakdown %}
            <li>{{ item.category }}: {{ item.value }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if latest_result.suggestions %}
        <h3 class="subtitle">Suggestions for Improvement</h3>
        <ul>
            {% for suggestion in latest_result.suggestions %}
            <li>{{ suggestion }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    

<!-- Load Chart.js Library -->
<!-- Adjusted Chart Container -->
<!-- Adjusted Chart Container -->
<div style="width: 100%; max-width: 800px; height: 400px; margin: auto;">
    <canvas id="historicalChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script> 

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const historicalData = JSON.parse('{{ chart_data|safe }}');

        // Limit the number of data points displayed to avoid excessive chart height
        const maxPoints = 30;
        if (historicalData.length > maxPoints) {
            historicalData.splice(0, historicalData.length - maxPoints);
        }

        const dates = historicalData.map(item => item.date);
        const energyUsage = historicalData.map(item => item.energy_usage);
        const scores = historicalData.map(item => item.score);

        const ctx = document.getElementById('historicalChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: 'Energy Usage (kWh/day)',
                        data: energyUsage,
                        borderColor: '#FF6384',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: true,
                        yAxisID: 'y1'
                    },
                    {
                        label: 'Sustainability Score',
                        data: scores,
                        borderColor: '#36A2EB',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        fill: false,
                        yAxisID: 'y2'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        },
                        grid: {
                            display: false // Remove grid from X-axis
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Energy Usage (kWh/day)'
                        },
                        beginAtZero: true,
                        grid: {
                            display: false // Remove grid from left Y-axis
                        }
                    },
                    y2: {
                        type: 'linear',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Sustainability Score'
                        },
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            display: false // Remove grid from right Y-axis
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    decimation: {
                        enabled: true,
                        algorithm: 'lttb',
                        samples: maxPoints
                    }
                }
            }
        });
    });
</script>
{% endblock %}
