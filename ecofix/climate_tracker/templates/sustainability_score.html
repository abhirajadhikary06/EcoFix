{% extends "base.html" %}

{% block title %}Sustainability Score - EcoVision{% endblock %}

{% block content %}
<div class="container">
    <h1 class="title">Your Sustainability Score</h1>
    
    <div class="box">
        <h2 class="subtitle"><b>Score:</b> {{ latest_result.score }}</h2>
        
        {% if latest_result.breakdown %}
        <h3 class="subtitle">Breakdown</h3>
        <ul>
            {% for item in latest_result.breakdown %}
            <li>{{ item.category }}: {{ item.value }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if latest_result.suggestions %}
        <h3 class="subtitle">Suggestions for Improvement</h3>
        <ul>
            {% for suggestion in latest_result.suggestions %}
            <li>{{ suggestion }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    

<!-- Load Chart.js Library -->
<!-- Adjusted Chart Container -->
<!-- Adjusted Chart Container -->
<!-- Load Google Charts Library -->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<!-- Chart Container -->
<div id="historicalChart" style="width: 100%; max-width: 800px; height: 400px; margin: auto;"></div>

<script>
    // Load the Visualization API and the corechart package.
    google.charts.load('current', {'packages':['corechart']});

    // Set a callback to run when the Google Visualization API is loaded.
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        // Parse JSON data from Django context
        const historicalData = JSON.parse('{{ chart_data|safe }}');

        // Limit data points to prevent excessive chart height
        const maxPoints = 30;
        if (historicalData.length > maxPoints) {
            historicalData.splice(0, historicalData.length - maxPoints);
        }

        // Prepare data for Google Charts (First row is the header)
        const chartData = [['Date', 'Energy Usage (kWh/day)', 'Sustainability Score']];
        historicalData.forEach(item => {
            chartData.push([item.date, item.energy_usage, item.score]);
        });

        // Convert the array into a DataTable
        var data = google.visualization.arrayToDataTable(chartData);

        // Chart options
        var options = {
            title: 'Energy Usage vs Sustainability Score',
            curveType: 'function', // Smooth lines
            legend: { position: 'top' },
            height: 400, // Fixed height
            chartArea: { width: '80%', height: '70%' }, // Adjust chart area
            hAxis: {
                title: 'Date',
                textStyle: { fontSize: 12 },
                slantedText: true, // Tilt labels if too many
                slantedTextAngle: 30
            },
            vAxis: {
                title: 'Values',
                textStyle: { fontSize: 12 },
                minValue: 0
            },
            series: {
                0: { color: '#FF6384' }, // Energy Usage (Red)
                1: { color: '#36A2EB' }  // Sustainability Score (Blue)
            }
        };

        // Draw the chart
        var chart = new google.visualization.LineChart(document.getElementById('historicalChart'));
        chart.draw(data, options);
    }
</script>

{% endblock %}
